## Take results files generated by analyze_wc_results.R and
## plot figures for paper.
library(ggplot2)
library(gridExtra)
library(cowplot)


integrateODE <- function(x0, ode, nt, T) {

    iterate <- function(dxdt, x) {
        dxdt*0.5*dt + x
    }

    finalize <- function(xp, x) {
        2*xp - x
    }

    x <- x0
    t <- 0
    dt <- T/(nt - 1)
    res <- data.frame(append(x, list(t=t)))

    for (tidx in 2:nt) {
        xp <- x

        for (i in 1:3) {
            xp <- mapply(iterate, ode(xp), x, SIMPLIFY=FALSE)
        }

        x <- mapply(finalize, xp, x, SIMPLIFY=FALSE)
        t <- (tidx-1)*dt

        res <- rbind(res, append(x, list(t=t)))
    }

    return(res)
}

sirCurve <- integrateODE(list(S=199,I=1,R=0), function(x) {
    return(list(S=-0.02*x$S*x$I, I=(0.02*x$S*x$I - 1*x$I), R=1*x$I))},
    1000, 5)

sisCurve <- integrateODE(list(S=199,I=1), function(x) {
    return(list(S=(-0.02*x$S*x$I + 1*x$I), I=(0.02*x$S*x$I - 1*x$I)))},
    1000, 5)

bdCurve <- integrateODE(list(I=1), function(x) {
    return(list(I=(0.5 - 0.1)*x$I))},
    1000, 10)


generateResultPlot <- function(resultsFile, minTime, maxTime) {
    results <- read.table(resultsFile, header=T)
    results$recoversTruth <- as.numeric((results$truth >= results$lower) &
                                          (results$truth <= results$upper))
    results$roundedAlpha <- round(results$alpha/0.05)*0.05

    p <- ggplot(subset(results, time>minTime))
    p <- p + geom_abline(slope = 1, intercept = 0, col="red")
    p <- p + stat_summary(aes(x=roundedAlpha, y=recoversTruth, group=time, col=time/maxTime),
                          fun.y="mean", geom="point")
    p <- p + xlim(0,1) + ylim(0,1)
    p <- p + xlab(expression(alpha))
    p <- p + ylab("Truth recovery proportion")
    p <- p + theme(plot.title = element_text(hjust=0.5))
    return(p)
}

generateInsetPlot <- function(curve, resultsFile, minTime) {

    results <- read.table(resultsFile, header=T)
    times <- unique(sort(results$time[which(results$time>minTime)]))
    maxTime <- max(curve$t)
    
    p <- ggplot(curve)
    p <- p + geom_line(aes(x=t, y=I))
    p <- p + scale_x_continuous(name=NA, breaks=c(0, maxTime), labels=c(expression(t[0]), 0))

    for (t in times) {
        f <- (t-minTime)/(maxTime-minTime)
        p <- p + geom_vline(xintercept=t, col=rgb(0.4*f,0.7*f,f))
    }

    p <- p + theme(axis.title=element_blank(),
                   axis.text.x = element_text(size=10),
                   axis.text.y = element_blank(),
                   axis.line.y = element_blank(),
                   axis.ticks.y = element_blank())
    return(p)
}


pBD <- generateResultPlot("resultsBD.txt", 4, 10) + ggtitle("(a)") + guides(col=FALSE)
pSIS <- generateResultPlot("resultsSIS.txt", 1, 5) + ggtitle("(b)") + guides(col=FALSE) +
    theme(axis.title.y=element_blank(), axis.text.y=element_blank())
pSIR <- generateResultPlot("resultsSIR.txt", 1, 5) + ggtitle("(c)") + guides(col=FALSE) +
#    guides(col=guide_colourbar(title=expression(t/t[0]))) +
    theme(axis.title.y=element_blank(), axis.text.y=element_blank()) +
    theme(legend.position=c(0.1,1), legend.justification=c(0,1),
          legend.key.height=unit(0.4, "cm"))

pBDinset <- generateInsetPlot(bdCurve, "resultsBD.txt", 4)
pSISinset <- generateInsetPlot(sisCurve, "resultsSIS.txt", 1)
pSIRinset <- generateInsetPlot(sirCurve, "resultsSIR.txt", 1)

pBD <- pBD + annotation_custom(grob=ggplotGrob(pBDinset), xmin=0.5, xmax=1.0, ymin=0.0, ymax=0.5)
pSIS <- pSIS + annotation_custom(grob=ggplotGrob(pSISinset), xmin=0.5, xmax=1.0, ymin=0.0, ymax=0.5)
pSIR <- pSIR + annotation_custom(grob=ggplotGrob(pSIRinset), xmin=0.5, xmax=1.0, ymin=0.0, ymax=0.5)

#p <- grid.arrange(pBD, pSIS, pSIR,
#                  layout_matrix=matrix(c(1, 2, 3), nrow=1, ncol=3, byrow=FALSE))
p <- plot_grid(pBD, pSIS, pSIR, align="h", ncol=3, nrow=1,
               rel_widths = c(1.25, 1, 1))
ggsave("trajectory_validation_figure.pdf", plot=p, width=20, height=8, units="cm")

